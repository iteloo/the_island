// Generated by CoffeeScript 1.7.1
(function() {
  var NotificationStage, error,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  this.PyAPI = (function() {
    function PyAPI(socket) {
      var me;
      this.socket = socket != null ? socket : null;
      if (this.socket == null) {
        this.socket = window.socket;
      }
      this.response_handlers = [];
      this.event_responders = [];
      me = this;
      this.socket.onmessage = (function(_this) {
        return function(message) {
          return setTimeout(function() {
            return _this.onmessage(message);
          }, 1);
        };
      })(this);
      this.transaction('server_info', {}, function(data) {
        console.log("Attempted version validation. Received response:");
        console.log(data);
        if (data.version !== window.config.server_version) {
          throw "VERSION_ERROR: Invalid reported server version " + data.version + ". Expecting " + window.config.server_version;
        }
      });
    }

    PyAPI.prototype.onmessage = function(message) {
      message = JSON.parse(message.data);
      if (message.method == null) {
        throw "Received illegal message '" + (JSON.stringify(message)) + "' without method header.";
      } else if (message.method === "handle_callback") {
        if (this.response_handlers[message.args.callback_id] == null) {
          throw "Received illegal callback ID in a handle_callback response.";
        }
        console.log('Received callback with arguments: ', message.args);
        return this.response_handlers[message.args.callback_id].call(this, message.args.callback_args);
      } else {
        console.log('Received method call: ', message.method);
        console.log('Method call data: ', message.args);
        return this.trigger_event(message.method, message.args);
      }
    };

    PyAPI.prototype.generate_transaction_id = function() {
      return "T" + Math.random();
    };

    PyAPI.prototype.register_for_event = function(eventName, response) {
      if (this.event_responders[eventName] == null) {
        this.event_responders[eventName] = [];
      }
      return this.event_responders[eventName].push(response);
    };

    PyAPI.prototype.trigger_event = function(eventName, data) {
      var e, response, _i, _len, _ref, _results;
      if (this.event_responders[eventName] != null) {
        _ref = this.event_responders[eventName];
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          e = _ref[_i];
          if (data.callback_id != null) {
            _results.push(response = e.call(window, data, new PyAPIResponder(data.callback_id, this)));
          } else {
            _results.push(e.call(window, data, new PyAPIDummyResponder()));
          }
        }
        return _results;
      }
    };

    PyAPI.prototype.transaction = function(method_name, args, responder) {
      var transaction_id, transmission;
      if (responder == null) {
        responder = null;
      }
      transmission = {
        method: method_name,
        args: args
      };
      if (responder != null) {
        transaction_id = this.generate_transaction_id();
        transmission.args.callback_id = transaction_id;
        this.response_handlers[transaction_id] = function(response) {
          return responder.call(this, response);
        };
      }
      this.socket.send(JSON.stringify(transmission));
      return console.log('Transaction sent: ', JSON.stringify(transmission));
    };

    PyAPI.prototype.reconnectWithSocket = function(new_socket) {
      this.socket.close();
      return this.socket = new_socket;
    };

    return PyAPI;

  })();

  this.PyAPIResponder = (function() {
    function PyAPIResponder(callback_id, parent) {
      this.callback_id = callback_id;
      this.parent = parent;
      true;
    }

    PyAPIResponder.prototype.respond = function(response) {
      this.parent.transaction('handle_callback', {
        callback_id: this.callback_id,
        callback_args: response
      });
      return true;
    };

    return PyAPIResponder;

  })();

  this.PyAPIDummyResponder = (function(_super) {
    __extends(PyAPIDummyResponder, _super);

    function PyAPIDummyResponder() {
      return PyAPIDummyResponder.__super__.constructor.apply(this, arguments);
    }

    PyAPIDummyResponder.prototype.respond = function() {
      return true;
    };

    return PyAPIDummyResponder;

  })(PyAPIResponder);

  window.Stage = (function() {
    function Stage() {
      this.time = 0;
      true;
    }

    Stage.prototype.bump = function() {
      return true;
    };

    Stage.prototype.trade_complete = function() {
      return true;
    };

    Stage.prototype.price_updated = function() {
      return true;
    };

    Stage.prototype.timer_begin = function() {
      return true;
    };

    Stage.prototype.end = function() {
      return true;
    };

    Stage.prototype.new_bid = function() {
      return true;
    };

    Stage.prototype.products_updated = function() {
      return true;
    };

    Stage.prototype.update = function() {
      return true;
    };

    return Stage;

  })();

  NotificationStage = (function(_super) {
    __extends(NotificationStage, _super);

    function NotificationStage() {
      return NotificationStage.__super__.constructor.apply(this, arguments);
    }

    NotificationStage.prototype.end = function() {
      return message.hide.call(message);
    };

    return NotificationStage;

  })(Stage);

  window.DayStage = (function(_super) {
    __extends(DayStage, _super);

    function DayStage() {
      this.dom_element = $("<div class='wait'><h3>Waiting for everyone else...</h3></div>");
      $(".interface").append(this.dom_element);
    }

    DayStage.prototype.end = function() {
      return this.dom_element.remove();
    };

    return DayStage;

  })(Stage);

  window.jevents = [];

  window.jevent = function(eventName, eventAction) {
    var f, _i, _len, _ref, _results;
    if (eventAction == null) {
      eventAction = null;
    }
    if (eventAction === null) {
      if (window.jevents[eventName] != null) {
        _ref = window.jevents[eventName];
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          f = _ref[_i];
          _results.push(f.call);
        }
        return _results;
      }
    } else {
      if (window.jevents[eventName] != null) {
        return window.jevents[eventName].push(eventAction);
      } else {
        return window.jevents[eventName] = [eventAction];
      }
    }
  };

  $(function() {
    var moving_average_samples;
    window.acc = {
      x: 0,
      y: 0,
      z: 0
    };
    window.avg_acc = false;
    moving_average_samples = 50;
    window.censor_gyroscope = false;
    return window.ondevicemotion = function(e) {
      var change, x, y, z;
      x = e.accelerationIncludingGravity.x;
      y = e.accelerationIncludingGravity.y;
      z = e.accelerationIncludingGravity.z;
      change = Math.abs(acc.x - x) + Math.abs(acc.y - y) + Math.abs(acc.z - z);
      window.acc = {
        x: x,
        y: y,
        z: z
      };
      if (change > 20 && !window.censor_gyroscope) {
        window.censor_gyroscope = true;
        window.stage.bump.call(window.stage);
        return setTimeout(function() {
          return window.censor_gyroscope = false;
        }, 500);
      }
    };
  });

  window.handleResize = function() {
    $('.statusbar').css('font-size', (0.9 * $('.statusbar').height()) + 'px');
    return $(window).scrollTop(0);
  };

  $(window).bind('resize', window.handleResize);

  $(function() {
    window.handleResize();
    $('.interface > div').each(function() {
      return $(this).hide();
    });
    if (($.ui == null) || ($.mobile == null)) {
      return location.reload(true);
    }
  });

  window.updateStatusBar = function() {
    return window.updateInterface();
  };

  window.updateInterface = function() {
    if (this.stage != null) {
      return this.stage.update();
    }
  };

  window.updateCountdown = function() {
    return $('.countdown').html(stage.time);
  };

  this.InventoryPanel = (function() {
    function InventoryPanel() {
      this.dom_element = $('.inventory');
      this.button_element = $('.inventory-button');
      this.button_element.click((function(_this) {
        return function() {
          return _this.toggle();
        };
      })(this));
      $('.inventory').sortable({
        helper: function(e, ui) {
          var type;
          type = ui.attr('data-production-type');
          if (player.products[type].amount <= 0) {
            return $('<div></div>');
          } else {
            return $("<div class='square placeholder'></div>").css('background-color', player.products[ui.attr('data-production-type')].color);
          }
        },
        start: function(e, ui) {
          return ui.item.show();
        },
        change: function() {
          return $(this).sortable("refreshPositions");
        },
        placeholder: 'test',
        stop: function(e, ui) {
          var item, offset;
          offset = ui.originalPosition.top - ui.position.top;
          if (stage instanceof TradingStage) {
            item = stage.products[ui.item.attr('data-production-type')];
            if (offset > 50) {
              item.trade.call(item);
            }
            return $(this).sortable('cancel');
          }
        }
      });
      this.quit_button = $("<div class='message-button quit-button'>Leave game</div>");
      this.quit_button.click((function(_this) {
        return function(e) {
          var m;
          e.preventDefault();
          console.log("quit button tapped!");
          m = new Message();
          m.respond = function(response) {
            if (response === true) {
              return pycon.transaction('quit');
            }
          };
          m.display("Sure to quit?", "", false, [
            {
              text: "leave game",
              id: true
            }, {
              text: "don't quit",
              id: false
            }
          ]);
          return true;
        };
      })(this));
      $('.inventory').append(this.quit_button);
      $('.inventory span.inventorycount').each(function() {
        var color, type;
        $(this).html("<span class='block'>&#9632;</span> x <span class='count'>0</span>");
        type = $(this).attr('data-production-type');
        color = player.products[type].color;
        $(this).children('.block').css('color', color);
        return $(this).hide();
      });
      $('.inventory span.inventorycount').taphold(function() {
        var type;
        type = $(this).attr('data-production-type');
        pycon.transaction('item_activated', {
          item_name: type
        });
        return console.log("I tried to use a " + type);
      });
      this.close();
      this.needsRefresh();
    }

    InventoryPanel.prototype.open = function() {
      return this.dom_element.show();
    };

    InventoryPanel.prototype.close = function() {
      return this.dom_element.hide();
    };

    InventoryPanel.prototype.toggle = function() {
      return this.dom_element.toggle();
    };

    InventoryPanel.prototype.needsRefresh = function() {
      var n, p, _ref;
      if (window.player != null) {
        _ref = window.player.products;
        for (n in _ref) {
          p = _ref[n];
          p.needsRefresh();
        }
      }
      return true;
    };

    return InventoryPanel;

  })();

  window.JobStage = (function(_super) {
    __extends(JobStage, _super);

    function JobStage() {
      var me;
      me = this;
      this.jobs = {};
      $('.ready').show();
      $('.ready').tap((function(_this) {
        return function() {
          return _this.ready();
        };
      })(this));
      $('.jobstage-interface').show();
      $('.jobstage-interface .box').each(function() {
        var jobcode;
        jobcode = $(this).attr('data-job-type');
        return me.jobs[jobcode] = new JobView($(this));
      });
      $('.jobstage-interface .box').fitText(1, {
        maxFontSize: '40px'
      });
      true;
    }

    JobStage.prototype.ready = function() {
      if (this.getSelectedJob()) {
        $('.ready').addClass('active');
        return pycon.transaction('ready');
      }
    };

    JobStage.prototype.getSelectedJob = function() {
      var job, name, _ref;
      _ref = this.jobs;
      for (name in _ref) {
        job = _ref[name];
        if (job.selected) {
          return job;
        }
      }
      return false;
    };

    JobStage.prototype.end = function() {
      var job, name, _i, _len, _ref;
      $('.jobstage-interface').hide();
      $('.ready').hide().unbind().removeClass('active');
      _ref = this.jobs;
      for (job = _i = 0, _len = _ref.length; _i < _len; job = ++_i) {
        name = _ref[job];
        j.end.call(j);
      }
      return $('.ready').hide().unbind();
    };

    JobStage.prototype.update_job_selections = function(data) {
      var job, players, _ref, _results;
      _ref = data.job_selections;
      _results = [];
      for (job in _ref) {
        players = _ref[job];
        console.log('==> ', job, ' with players ', players);
        this.jobs[job].number_players = players.length;
        _results.push(this.jobs[job].needsRefresh.call(this.jobs[job]));
      }
      return _results;
    };

    return JobStage;

  })(Stage);

  window.JobView = (function() {
    function JobView(dom_object) {
      var me;
      this.dom_object = dom_object;
      me = this;
      this.job = window.jobs[this.dom_object.attr('data-job-type')];
      this.job_code = this.dom_object.attr('data-job-type');
      this.dom_object.css('background-color', this.job.color);
      this.selected = false;
      this.number_players = 0;
      this.dom_object.tap(function() {
        return me.tap.call(me);
      });
      this.needsRefresh();
    }

    JobView.prototype.select = function() {
      var job, q, _ref;
      _ref = window.stage.jobs;
      for (q in _ref) {
        job = _ref[q];
        job.unselect.call(job);
      }
      this.selected = true;
      pycon.transaction('job_selected', {
        job: this.job_code
      });
      return this.needsRefresh();
    };

    JobView.prototype.unselect = function() {
      this.selected = false;
      return this.needsRefresh();
    };

    JobView.prototype.tap = function() {
      if (this.selected) {

      } else {
        return this.select();
      }
    };

    JobView.prototype.needsRefresh = function() {
      var player_string;
      this.dom_object.html('');
      this.dom_object.append($("<h3>" + this.job.title + "</h3>"));
      player_string = Array(this.number_players + 1).join("&#9679;");
      this.dom_object.append($("<p>" + player_string + "</p>"));
      if (!this.selected) {
        return this.dom_object.css('opacity', '0.5');
      } else {
        return this.dom_object.css('opacity', '1');
      }
    };

    JobView.prototype.end = function() {
      return this.dom_object.unbind();
    };

    return JobView;

  })();

  this.LoginController = (function() {
    function LoginController() {
      var cookie, err;
      this.background = $("<div class='overlay login-background'><h3>Who are you?</h3><input value=name type=text /><br /><br /><div class='message-button'>OK</div></div>").show();
      this.button = this.background.children('.message-button');
      this.input = this.background.children('input');
      cookie = {};
      try {
        cookie = JSON.parse(document.cookie);
      } catch (_error) {
        err = _error;
        true;
      }
      if (cookie.username != null) {
        this.input.val(cookie.username);
      }
      this.button.tap((function(_this) {
        return function() {
          return _this.finish();
        };
      })(this));
      $(".interface").append(this.background);
    }

    LoginController.prototype.finish = function() {
      document.cookie = name + '=; expires=Thu, 01-Jan-70 00:00:01 GMT;';
      document.cookie = JSON.stringify({
        username: this.input.val()
      });
      this.background.remove();
      return window.connectToGame();
    };

    return LoginController;

  })();

  window.config = $.ajax({
    type: "GET",
    url: "/configuration.json",
    async: false
  }).responseText;

  try {
    window.config = JSON.parse(window.config);
  } catch (_error) {
    error = _error;
    throw "Configuration loaded from 'configuration.json' is invalid.";
  }

  if ((typeof TEST !== "undefined" && TEST !== null) && TEST === true) {
    $(function() {
      var t;
      console.log("Initializing testing mode.");
      t = new TestSuite();
      return t.run();
    });
  } else {
    $(function() {
      return window.login_controller = new LoginController();
    });
  }

  window.connectToGame = function() {
    window.socket = new WebSocket("ws://" + location.host + "/json");
    window.jevent('SocketOpened', function() {});
    console.log('The socket was opened.');
    socket.onopen = function() {
      console.log("Socket connection opened successfully.");
      window.pycon = new PyAPI(window.socket);
      return window.go();
    };
    return socket.onclose = function() {
      var m;
      console.log("Socket connection was closed, unexpectedly.");
      m = new Message();
      return m.display("Oh No!", "I don't know why, but the socket was closed (!)");
    };
  };

  window.go = function() {
    pycon.transaction('name_entered', {
      name: login_controller.input.val()
    });
    pycon.register_for_event('update_game_info', function(data) {
      console.log('Player count changed: ', data);
      return $('.playercount').html(data.player_count);
    });
    pycon.register_for_event('stage_begin', function(data, responder) {
      if (typeof stage !== "undefined" && stage !== null) {
        window.stage.end();
      }
      if (data.stage_type === 'Job') {
        window.stage = new JobStage();
      } else if (data.stage_type === 'Day') {
        window.stage = new DayStage();
      } else if (data.stage_type === 'Production') {
        window.stage = new ProductionStage();
      } else if (data.stage_type === 'Notification') {
        window.stage = new NotificationStage();
      } else if (data.stage_type === 'Trading') {
        window.stage = new TradingStage();
      } else {
        throw "Illegal stage sent: " + data.stageType;
      }
      return responder.respond();
    });
    pycon.register_for_event('update_player_info', function(data) {
      var amount, name, _ref;
      _ref = data.inventory;
      for (name in _ref) {
        amount = _ref[name];
        if ((window.stage != null) && window.stage instanceof TradingStage) {
          player.products[name].amount = amount - window.stage.products[name].for_trade;
        } else {
          player.products[name].amount = amount;
        }
      }
      if (data.condition != null) {
        if (data.condition.health != null) {
          player.setHealth(data.condition.health);
        }
        if (data.condition.antihunger != null) {
          player.setFood(data.condition.antihunger);
        }
      }
      if (typeof stage !== "undefined" && stage !== null) {
        stage.update();
      }
      window.inventorypanel.needsRefresh();
      return window.updateInterface();
    });
    pycon.register_for_event('display_event', function(data, responder) {
      var inputs, m, o, options, _i, _len;
      if (data.clickable == null) {
        data.clickable = false;
      }
      options = [];
      if (data.responses != null) {
        options = data.responses;
      }
      inputs = [];
      if (data.inputs != null) {
        inputs = data.inputs;
      }
      m = new Message();
      for (_i = 0, _len = options.length; _i < _len; _i++) {
        o = options[_i];
        if ((o.display != null) && o.display === "background") {
          m.close = (function(_this) {
            return function() {
              return responder.respond({
                response_chosen_id: o.id
              });
            };
          })(this);
          data.clickable = true;
          break;
        }
      }
      m.respond = (function(_this) {
        return function(response) {
          return responder.respond({
            response_chosen_id: response,
            inputs: m.input_states()
          });
        };
      })(this);
      return m.display(data.title, data.text, data.clickable, options, inputs);
    });
    pycon.register_for_event('InventoryCountRequested', function(data) {
      return pycon.transaction({
        action: data.callback,
        data: player.getInventoryCount.call(player)
      });
    });
    pycon.register_for_event('update_job_selections', function(data) {
      if (stage.update_job_selections != null) {
        return stage.update_job_selections.call(stage, data);
      }
    });
    pycon.register_for_event('echo', function(data, responder) {
      return responder.respond(data);
    });
    pycon.register_for_event('GivePoints', function(data) {
      return player.givePoints(data.amount);
    });
    pycon.register_for_event('refresh', function(data) {
      return location.reload(0);
    });
    pycon.register_for_event('TimerBegin', function(data) {
      console.log('Event handled: ', stage);
      return stage.timer_begin.call(stage, data.duration);
    });
    pycon.register_for_event('RequestProductionReport', function(data) {
      if (stage.report_production != null) {
        return stage.report_production();
      }
    });
    setInterval((function(_this) {
      return function() {
        return pycon.transaction('echo', {}, function() {
          return true;
        });
      };
    })(this), 20000);
    updateStatusBar();
    $('.statusbar').show();
    return window.inventorypanel = new InventoryPanel();
  };

  window.Message = (function() {
    function Message() {
      this.dom_element = $("<div class='message' data-role='page'><h3 class='title'></h3><p class='text'></p><div class='message-inputs'></div><div class='message-buttons'></div></div>");
      this.timeout = 5;
      this.onclose = (function(_this) {
        return function() {
          return true;
        };
      })(this);
    }

    Message.prototype.display = function(title, text, clickable, options, inputs, duration) {
      var i, k, me, o, _i, _j, _len, _len1, _ref;
      if (clickable == null) {
        clickable = true;
      }
      if (options == null) {
        options = [];
      }
      if (inputs == null) {
        inputs = [];
      }
      if (duration == null) {
        duration = null;
      }
      me = this;
      $(".interface").append(this.dom_element);
      $('.overlay').show();
      if (text == null) {
        text = '';
      }
      if (title == null) {
        title = '';
      }
      this.dom_element.children('.title').html(title);
      this.dom_element.children('.text').html(text);
      this.dom_element.show();
      this.inputs = {};
      if ((inputs != null) && inputs.length > 0) {
        for (_i = 0, _len = inputs.length; _i < _len; _i++) {
          i = inputs[_i];
          if ((i.id != null) && i.type === "textbox") {
            this.inputs[i.id] = $("<input type=text class='message-input message-input-textbox' />");
          }
        }
      }
      this.dom_element.children('.message-inputs').html("");
      _ref = this.inputs;
      for (k in _ref) {
        i = _ref[k];
        this.dom_element.children('.message-inputs').append(i);
      }
      this.buttons = [];
      this.dom_element.children('.message-buttons').html('');
      if ((options != null) && options.length > 0) {
        for (_j = 0, _len1 = options.length; _j < _len1; _j++) {
          o = options[_j];
          if ((o.display == null) || o.display === "button") {
            this.buttons.push(new MessageButton(this, o.text, o.id));
          }
        }
      }
      if (clickable) {
        this.dom_element.tap((function(_this) {
          return function() {
            _this.close();
            _this.hide();
            return _this.destroy;
          };
        })(this));
      }
      if (duration != null) {
        setTimeout((function(_this) {
          return function() {
            return window.message.hide();
          };
        })(this), duration * 1000);
      }
      return window.inventorypanel.close();
    };

    Message.prototype.input_states = function() {
      var i, k, state, _ref;
      state = {};
      _ref = this.inputs;
      for (k in _ref) {
        i = _ref[k];
        state[k] = i.val();
      }
      return state;
    };

    Message.prototype.respond = function(response) {
      return true;
    };

    Message.prototype.close = function() {
      return true;
    };

    Message.prototype.destroy = function() {
      return this.dom_element.remove();
    };

    Message.prototype.hide = function() {
      this.onclose();
      this.dom_element.unbind();
      this.dom_element.hide();
      return $('.overlay').hide();
    };

    return Message;

  })();

  this.MessageButton = (function() {
    function MessageButton(parent, text, id) {
      this.parent = parent;
      this.text = text;
      this.id = id;
      this.dom_element = $("<div class='message-button'>" + this.text + "</div>");
      this.dom_element.tap((function(_this) {
        return function() {
          return _this.click();
        };
      })(this));
      this.parent.dom_element.children(".message-buttons").append(this.dom_element);
    }

    MessageButton.prototype.click = function() {
      this.parent.respond(this.id);
      return this.parent.hide();
    };

    return MessageButton;

  })();

  window.Player = (function() {
    function Player() {
      var p, _i, _len, _ref;
      this.products = [];
      this.health = 100;
      this.food = 100;
      this.productionfacilities = [];
      _ref = ['bandage', 'food', 'bullet', 'log'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        this.products[p] = new Product(p);
      }
      this.products['bandage'].color = '#DD514C';
      this.products['food'].color = '#5EB95E';
      this.products['bullet'].color = '#777';
      this.products['log'].color = '#5E2605';
      true;
    }

    Player.prototype.getInventoryCount = function() {
      var inventory, name, p, _ref;
      inventory = {};
      _ref = this.products;
      for (name in _ref) {
        p = _ref[name];
        inventory[name] = p.amount;
      }
      return inventory;
    };

    Player.prototype.update = function() {
      this.setHealth(this.health);
      return this.setFood(this.food);
    };

    Player.prototype.setHealth = function(amount) {
      var health_points, health_string;
      if (amount < 100) {
        this.health = amount;
      } else {
        this.health = 100;
      }
      health_points = Math.ceil(this.health / 34.0);
      health_string = Array(health_points + 1).join("&#9829;") + Array(4 - health_points).join("<span class='antiheart'>&#9829;</span>");
      return $('.statusbar .health').html(health_string);
    };

    Player.prototype.setFood = function(amount) {
      var food_points, food_string;
      if (amount < 100) {
        this.food = amount;
      } else {
        this.food = 100;
      }
      food_points = Math.ceil(this.food / 50.0);
      if (this.food < 10) {
        food_points = 0;
      }
      food_string = Array(food_points + 1).join("<span class='food'>&nbsp;&nbsp;&nbsp;</span>") + Array(3 - food_points).join("<span class='anti food'>&nbsp;&nbsp;&nbsp;</span>");
      return $('.statusbar .hunger').html(food_string);
    };

    return Player;

  })();

  window.Product = (function() {
    function Product(name) {
      this.name = name;
      this.amount = 0;
      this.color = "green";
      true;
    }

    Product.prototype.activate = function() {
      return pycon.transaction('item_activated', {
        item_name: this.name
      });
    };

    Product.prototype.needsRefresh = function() {
      if (this.amount > 0) {
        return $(".inventory .inventorycount[data-production-type='" + this.name + "']").show().children('span.count').html(this.amount);
      } else {
        return $(".inventory .inventorycount[data-production-type='" + this.name + "']").hide();
      }
    };

    return Product;

  })();

  window.Job = (function() {
    function Job(title, color) {
      this.title = title;
      this.color = color;
      true;
    }

    return Job;

  })();

  window.jobs = {};

  jobs['hospital'] = new Job('Hospital', '#DD514C');

  jobs['production'] = new Job('Production', '#FAD232');

  jobs['farm'] = new Job('Farm', '#5EB95E');

  jobs['watchtower'] = new Job('Watchtower', '#777');

  window.player = new Player();

  window.TestSuite = (function() {
    function TestSuite() {
      this.dom_element = $('.test-output');
      this.passed = 0;
      this.test_count = Object.keys(tests).length;
      window.onerror = (function(_this) {
        return function() {
          return _this.fail();
        };
      })(this);
      this.failed = false;
    }

    TestSuite.prototype.run = function() {
      console.log("Starting TestSuite...");
      this.passed = 0;
      this.test_keys = Object.keys(tests);
      return this._run_next_test();
    };

    TestSuite.prototype._run_next_test = function() {
      var err, name, test;
      name = this.test_keys.shift();
      if (name == null) {
        console.log("All tests passed.");
        this.dom_element.after("<h1>All tests passed.</h1>");
        this.dom_element.css('color', 'green');
        return;
      }
      test = window.tests[name];
      console.log("Running test '" + name + "'...");
      try {
        if (!test(new TestDelegate(this))) {
          throw "test '" + name + "' returned invalid value";
        }
      } catch (_error) {
        err = _error;
        this.failed = true;
        console.warn("Test '" + name + "' failed with error '" + err + "'");
        throw "Test suite ended due to failed test.";
      }
    };

    TestSuite.prototype.pass = function() {
      this.passed++;
      this.report_state();
      return this._run_next_test();
    };

    TestSuite.prototype.fail = function() {
      this.report_state();
      return this.dom_element.after("<h1 style='color:red'>Test failed</h1>");
    };

    TestSuite.prototype.report_state = function() {
      return this.dom_element.html("" + this.passed + " / " + this.test_count + " tests passed.");
    };

    return TestSuite;

  })();

  window.TestDelegate = (function() {
    function TestDelegate(parent) {
      this.parent = parent;
      true;
    }

    TestDelegate.prototype.pass = function() {
      this.parent.pass();
      return true;
    };

    TestDelegate.prototype.fail = function() {
      this.parent.fail();
      return false;
    };

    return TestDelegate;

  })();

  window.assert = function(statement, error) {
    if (!statement) {
      throw error;
    } else {
      return true;
    }
  };

  window.tests = {
    'Connect to the host': function(t) {
      window.socket = new WebSocket("ws://" + location.host + "/json");
      socket.onopen = function() {
        socket.close();
        return t.pass();
      };
      return true;
    },
    'Start socket, and observe stage_begin': function(t) {
      window.socket = new WebSocket("ws://" + location.host + "/json");
      socket.onopen = function() {
        window.pycon = new PyAPI(window.socket);
        pycon.register_for_event('stage_begin', function(data, responder) {
          responder.respond();
          return setTimeout(function() {
            return t.pass();
          }, 250);
        });
        return window.go();
      };
      return true;
    },
    'Test: update_player_info': function(t) {
      var m;
      m = {
        method: 'update_player_info',
        args: {
          inventory: {
            bandage: Math.round(Math.random() * 100),
            food: Math.round(Math.random() * 100),
            bullet: Math.round(Math.random() * 100),
            log: Math.round(Math.random() * 100)
          },
          condition: {
            health: Math.round(Math.random() * 100),
            antihunger: Math.round(Math.random() * 100)
          }
        }
      };
      pycon.onmessage({
        data: JSON.stringify(m)
      });
      assert(player.products.bandage.amount === m.args.inventory.bandage, "Failed inventory update");
      assert(player.products.food.amount === m.args.inventory.food, "Failed inventory update");
      assert(player.products.bullet.amount === m.args.inventory.bullet, "Failed inventory update");
      assert(player.products.log.amount === m.args.inventory.log, "Failed inventory update");
      assert(player.health === m.args.condition.health, "Failed condition:health update");
      assert(player.food === m.args.condition.antihunger, "Failed condition:antihunger update");
      return t.pass();
    }
  };

  window.TradingStage = (function(_super) {
    __extends(TradingStage, _super);

    function TradingStage() {
      var me;
      console.log("testing testing");
      me = this;
      this.type = 'TradingStage';
      this.timers = [];
      $('.tradingstage-interface').show();
      player.update();
      $('.ready').show();
      $('.ready').tap((function(_this) {
        return function() {
          return _this.ready();
        };
      })(this));
      $('.health').show();
      $('.hunger').show();
      this.products = {};
      $('.tradingstage-interface .trading span.tradecount').each(function() {
        var type;
        type = $(this).attr('data-production-type');
        $(this).children('.block').css('background-color', player.products[type].color);
        me.products[type] = new TradingProduct($(this), player.products[type]);
        me.products[type].product.needsRefresh();
        me.refreshTradingPlatform();
        return window.inventorypanel.needsRefresh();
      });
      setTimeout((function(_this) {
        return function() {
          var p, _i, _len, _ref;
          _ref = _this.products;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            p = _ref[_i];
            p.product.needsRefresh();
          }
          window.inventorypanel.needsRefresh();
          return _this.refreshTradingPlatform();
        };
      })(this), 300);
      $('.tradingstage-interface .trading span.tradecount').each(function() {
        var color, type;
        $(this).html("<span class='block'>&#9632;</span> x <span class='count'>0</span>");
        type = $(this).attr('data-production-type');
        color = player.products[type].color;
        $(this).children('.block').css('color', color);
        return $(this).hide();
      });
      $('.trading').on("taphold", (function(_this) {
        return function() {
          return _this.clearTrades();
        };
      })(this));
      $('.countdown').show();
      TradingStage.__super__.constructor.apply(this, arguments);
    }

    TradingStage.prototype.ready = function() {
      $('.ready').addClass('active');
      return pycon.transaction('ready');
    };

    TradingStage.prototype.end = function() {
      var interval, _i, _len, _ref;
      $('.countdown').hide();
      $('.ready').hide().unbind().removeClass('active');
      $('.tradingstage-interface').hide();
      $('.trading').unbind();
      $('.health').hide();
      $('.hunger').hide();
      $('.tradingstage-interface .inventory').sortable('destroy');
      if ($('.placeholder').length > 0) {
        $('.placeholder').remove();
      }
      this.clearTrades();
      _ref = this.timers;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        interval = _ref[_i];
        clearInterval(interval);
      }
      return TradingStage.__super__.end.apply(this, arguments);
    };

    TradingStage.prototype.bump = function() {
      var items, name, p, _ref;
      items = {};
      _ref = this.products;
      for (name in _ref) {
        p = _ref[name];
        if (p.for_trade > 0) {
          items[name] = p.for_trade;
        }
      }
      return pycon.transaction('trade_proposed', {
        items: items
      }, (function(_this) {
        return function(r) {
          var amount, _ref1, _ref2;
          _ref1 = _this.products;
          for (name in _ref1) {
            p = _ref1[name];
            p.for_trade = 0;
          }
          _ref2 = r.items;
          for (name in _ref2) {
            amount = _ref2[name];
            _this.products[name].for_trade = amount;
          }
          window.inventorypanel.needsRefresh();
          return _this.refreshTradingPlatform();
        };
      })(this));
    };

    TradingStage.prototype.clearTrades = function() {
      var name, p, _ref;
      _ref = this.products;
      for (name in _ref) {
        p = _ref[name];
        if (p.for_trade > 0) {
          p.product.amount += p.for_trade;
          p.for_trade = 0;
          p.needsRefresh.call(p);
        }
      }
      this.refreshTradingPlatform();
      return window.inventorypanel.needsRefresh();
    };

    TradingStage.prototype.trade_complete = function(data) {
      var amount, card, name, p, _i, _len, _ref, _ref1, _ref2;
      _ref = this.products;
      for (name in _ref) {
        p = _ref[name];
        p.for_trade = 0;
      }
      _ref1 = player.cards;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        card = _ref1[_i];
        card.on_trade_end.call(card, data.items);
      }
      _ref2 = data.items;
      for (name in _ref2) {
        amount = _ref2[name];
        if (this.products[name] != null) {
          this.products[name].for_trade = amount;
          this.products[name].needsRefresh.call(this.products[name]);
        }
      }
      return this.refreshTradingPlatform();
    };

    TradingStage.prototype.price_updated = function() {
      var name, p, _ref, _results;
      _ref = this.products;
      _results = [];
      for (name in _ref) {
        p = _ref[name];
        _results.push(p.needsRefresh.call(p));
      }
      return _results;
    };

    TradingStage.prototype.products_updated = function() {
      return this.price_updated();
    };

    TradingStage.prototype.update = function() {
      this.price_updated();
      this.refreshTradingPlatform();
      return window.inventorypanel.needsRefresh();
    };

    TradingStage.prototype.refreshTradingPlatform = function() {
      var name, p, _ref, _results;
      _ref = this.products;
      _results = [];
      for (name in _ref) {
        p = _ref[name];
        if (p.for_trade > 0) {
          _results.push($(".tradingstage-interface .tradecount[data-production-type='" + name + "']").show().children('.count').html(p.for_trade));
        } else {
          _results.push($(".tradingstage-interface .tradecount[data-production-type='" + name + "']").hide());
        }
      }
      return _results;
    };

    TradingStage.prototype.yield_production = function() {
      var card, facility, name, p, _i, _len, _ref, _ref1, _results;
      _ref = this.products;
      for (name in _ref) {
        p = _ref[name];
        facility = player.productionfacilities[name];
        facility.run_factory.call(facility);
        p.needsRefresh.call(p);
      }
      _ref1 = player.cards;
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        card = _ref1[_i];
        _results.push(card.on_production.call(card));
      }
      return _results;
    };

    TradingStage.prototype.timer_begin = function(countdown) {
      var count_down, me;
      me = this;
      this.time = countdown;
      count_down = function() {
        if (stage.time > 0) {
          stage.time -= 1;
        }
        return updateCountdown();
      };
      this.timers.push(setInterval(count_down, 1000));
      return updateCountdown();
    };

    return TradingStage;

  })(Stage);

  window.TradingProduct = (function() {
    function TradingProduct(dom_element, product) {
      this.dom_element = dom_element;
      this.product = product;
      this.needsRefresh();
      this.for_trade = 0;
      true;
    }

    TradingProduct.prototype.trade = function() {
      if (this.product.amount > 0) {
        this.for_trade += 1;
        this.product.amount -= 1;
        this.needsRefresh();
        window.inventorypanel.needsRefresh();
        stage.refreshTradingPlatform.call(stage);
        return true;
      } else {
        return false;
      }
    };

    TradingProduct.prototype.sell = function() {
      return true;
    };

    TradingProduct.prototype.needsRefresh = function() {
      return true;
    };

    return TradingProduct;

  })();

}).call(this);
